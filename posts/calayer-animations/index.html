<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="CALayer Animations" /><meta property="og:locale" content="en" /><meta name="description" content="Create custom progress view using CALayer and CoreAnimation." /><meta property="og:description" content="Create custom progress view using CALayer and CoreAnimation." /><link rel="canonical" href="https://blog.grigory.nl/posts/calayer-animations/" /><meta property="og:url" content="https://blog.grigory.nl/posts/calayer-animations/" /><meta property="og:site_name" content="Grigory Avdyushin" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-09-18T11:28:21+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CALayer Animations" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-02T18:22:43+02:00","datePublished":"2018-09-18T11:28:21+02:00","description":"Create custom progress view using CALayer and CoreAnimation.","headline":"CALayer Animations","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.grigory.nl/posts/calayer-animations/"},"url":"https://blog.grigory.nl/posts/calayer-animations/"}</script><title>CALayer Animations | Grigory Avdyushin</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Grigory Avdyushin"><meta name="application-name" content="Grigory Avdyushin"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/swissAvatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Grigory Avdyushin</a></div><div class="site-subtitle font-italic">Personal blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/avdyushin" aria-label="github" > <i class="fab fa-github"></i> </a> <a href="https://linkedin.com/in/avdyushin" aria-label="linkedin" > <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>CALayer Animations</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>CALayer Animations</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1537262901" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 18, 2018 </em> </span> <span> Updated <em class="" data-ts="1662135763" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 2, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/avdyushin">Grigory Avdyushin</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1448 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><p>Create custom progress view using <code class="language-plaintext highlighter-rouge">CALayer</code> and <code class="language-plaintext highlighter-rouge">CoreAnimation</code>.</p><p>Start with base class and protocols. Our base class should have <code class="language-plaintext highlighter-rouge">progress</code> property marked as <code class="language-plaintext highlighter-rouge">@NSManaged</code> to work with CoreAnimation. Also we need to redraw our layer on progress property update. To do it override <code class="language-plaintext highlighter-rouge">needsDisplay(forKey:)</code> method.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c1">/// Base progress layer class</span>
<span class="kd">class</span> <span class="kt">BaseProgressLayer</span><span class="p">:</span> <span class="kt">CALayer</span> <span class="p">{</span>

    <span class="c1">/// Progress key path constant string</span>
    <span class="kd">enum</span> <span class="kt">Keys</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">progress</span> <span class="o">=</span> <span class="s">"progress"</span>
    <span class="p">}</span>

    <span class="c1">/// To work with CoreAnimation this property should be marked ass @NSManaged</span>
    <span class="c1">/// which generates getter and setter</span>
    <span class="kd">@NSManaged</span> <span class="k">var</span> <span class="nv">progress</span><span class="p">:</span> <span class="kt">CGFloat</span>

    <span class="c1">/// Redraw during progress value animation</span>
    <span class="k">override</span> <span class="kd">class</span> <span class="kd">func</span> <span class="nf">needsDisplay</span><span class="p">(</span><span class="n">forKey</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="kt">Keys</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">rawValue</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">super</span><span class="o">.</span><span class="nf">needsDisplay</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Progress view protocol is simple. Just read-only <code class="language-plaintext highlighter-rouge">progress</code> value and <code class="language-plaintext highlighter-rouge">update</code> method to set new progress value.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c1">/// View with progress value and ability to update</span>
<span class="kd">protocol</span> <span class="kt">ProgressableView</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">progress</span><span class="p">:</span> <span class="kt">CGFloat</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">update</span><span class="p">(</span><span class="n">_</span> <span class="nv">progress</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">,</span> <span class="nv">animated</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now we can start with our progress view itself. It will be generic class with <code class="language-plaintext highlighter-rouge">BaseProgressLayer</code> as <code class="language-plaintext highlighter-rouge">Layer</code> and confirmed to <code class="language-plaintext highlighter-rouge">ProgressableView</code> protocol.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="c1">/// Progress view itself which supports animated progress value changes</span>
<span class="kd">class</span> <span class="kt">ProgressView</span><span class="o">&lt;</span><span class="kt">Layer</span><span class="p">:</span> <span class="kt">BaseProgressLayer</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">UIView</span><span class="p">,</span> <span class="kt">ProgressableView</span> <span class="p">{</span>

    <span class="c1">/// This view is backed by our Layer</span>
    <span class="k">override</span> <span class="kd">class</span> <span class="k">var</span> <span class="nv">layerClass</span><span class="p">:</span> <span class="kt">AnyClass</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">Layer</span><span class="o">.</span><span class="k">self</span>
    <span class="p">}</span>

    <span class="c1">/// Update content scale to window's one</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">didMoveToWindow</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">didMoveToWindow</span><span class="p">()</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">window</span> <span class="o">=</span> <span class="n">window</span> <span class="p">{</span>
            <span class="n">progressLayer</span><span class="o">.</span><span class="n">contentsScale</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">progressLayer</span><span class="o">.</span><span class="nf">setNeedsDisplay</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// Just for easy access</span>
    <span class="k">var</span> <span class="nv">progressLayer</span><span class="p">:</span> <span class="kt">Layer</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">layer</span> <span class="k">as!</span> <span class="kt">Layer</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="k">var</span> <span class="nv">progress</span><span class="p">:</span> <span class="kt">CGFloat</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">progressLayer</span><span class="o">.</span><span class="n">progress</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">update</span><span class="p">(</span><span class="n">_</span> <span class="nv">progress</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">,</span> <span class="nv">animated</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Not implemented yet</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Set new progress value without animation is very straightforward. Remove progress animation, set new progress and set needs display.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">func</span> <span class="nf">updateInstantly</span><span class="p">(</span><span class="n">_</span> <span class="nv">progress</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">progressLayer</span><span class="o">.</span><span class="nf">removeAnimation</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="kt">BaseProgressLayer</span><span class="o">.</span><span class="kt">Keys</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">rawValue</span><span class="p">)</span>
    <span class="n">progressLayer</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">progress</span>
    <span class="n">progressLayer</span><span class="o">.</span><span class="nf">setNeedsDisplay</span><span class="p">()</span>
<span class="p">}</span>
</pre></table></code></div></div><p>To make it animated we need to create new <code class="language-plaintext highlighter-rouge">CABasicAnimation</code> for our <code class="language-plaintext highlighter-rouge">@NSManaged</code> progress key. Also we need to keep new progress value after animation ended.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">func</span> <span class="nf">updateAnimated</span><span class="p">(</span><span class="n">_</span> <span class="nv">progress</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">progressLayer</span><span class="o">.</span><span class="nf">removeAnimation</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="kt">BaseProgressLayer</span><span class="o">.</span><span class="kt">Keys</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">rawValue</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">animation</span> <span class="o">=</span> <span class="kt">CABasicAnimation</span><span class="p">(</span><span class="nv">keyPath</span><span class="p">:</span> <span class="kt">BaseProgressLayer</span><span class="o">.</span><span class="kt">Keys</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">rawValue</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">oldValue</span> <span class="o">=</span> <span class="n">progressLayer</span><span class="o">.</span><span class="nf">presentation</span><span class="p">()?</span><span class="o">.</span><span class="n">progress</span> <span class="p">??</span> <span class="mi">0</span>
    <span class="n">progressLayer</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">oldValue</span>
    <span class="n">animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="n">oldValue</span>
    <span class="n">animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="n">progress</span>
    <span class="n">animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="kt">CFTimeInterval</span><span class="p">(</span><span class="nf">fabsf</span><span class="p">(</span><span class="kt">Float</span><span class="p">(</span><span class="n">oldValue</span> <span class="o">-</span> <span class="n">progress</span><span class="p">)))</span>
    <span class="n">animation</span><span class="o">.</span><span class="n">fillMode</span> <span class="o">=</span> <span class="n">kCAFillModeForwards</span>
    <span class="n">animation</span><span class="o">.</span><span class="n">isRemovedOnCompletion</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="n">animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="kt">CAMediaTimingFunction</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="n">kCAMediaTimingFunctionEaseInEaseOut</span><span class="p">)</span>
    <span class="n">animation</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
    <span class="n">progressLayer</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="kt">BaseProgressLayer</span><span class="o">.</span><span class="kt">Keys</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">rawValue</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">animationDidStop</span><span class="p">(</span><span class="n">_</span> <span class="nv">anim</span><span class="p">:</span> <span class="kt">CAAnimation</span><span class="p">,</span> <span class="n">finished</span> <span class="nv">flag</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="n">anim</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="s">"toValue"</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">CGFloat</span> <span class="p">{</span>
        <span class="n">progressLayer</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">value</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now we can complete <code class="language-plaintext highlighter-rouge">update</code> method:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">func</span> <span class="nf">update</span><span class="p">(</span><span class="n">_</span> <span class="nv">progress</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">,</span> <span class="nv">animated</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">animated</span> <span class="p">{</span>
        <span class="nf">updateAnimated</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nf">updateInstantly</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We have flexible progress view which draws nothing! It’s time to make simple circle progress view. First of all we need to create new layer subclass to make our drawings of progress.</p><p>We override <code class="language-plaintext highlighter-rouge">draw(in:)</code> function to draw our filled circles based on progress value.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre><td class="rouge-code"><pre><span class="c1">/// Layer to style circle view progress</span>
<span class="kd">class</span> <span class="kt">CircleProgressLayer</span><span class="p">:</span> <span class="kt">BaseProgressLayer</span> <span class="p">{</span>

    <span class="kd">@NSManaged</span> <span class="k">var</span> <span class="nv">segmentsCount</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="kd">@NSManaged</span> <span class="k">var</span> <span class="nv">trackColor</span><span class="p">:</span> <span class="kt">UIColor</span>
    <span class="kd">@NSManaged</span> <span class="k">var</span> <span class="nv">trackLineWidth</span><span class="p">:</span> <span class="kt">CGFloat</span>
    <span class="kd">@NSManaged</span> <span class="k">var</span> <span class="nv">progressColor</span><span class="p">:</span> <span class="kt">UIColor</span>
    <span class="kd">@NSManaged</span> <span class="k">var</span> <span class="nv">progressLineWidth</span><span class="p">:</span> <span class="kt">CGFloat</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">draw</span><span class="p">(</span><span class="k">in</span> <span class="nv">ctx</span><span class="p">:</span> <span class="kt">CGContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="nf">clear</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
        <span class="nf">drawTrack</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">ctx</span><span class="p">)</span>
        <span class="nf">drawProgress</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">step</span><span class="p">:</span> <span class="kt">CGFloat</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">CGFloat</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">segmentsCount</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">radius</span><span class="p">:</span> <span class="kt">CGFloat</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">min</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="n">trackLineWidth</span><span class="p">,</span> <span class="n">progressLineWidth</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">center</span><span class="p">:</span> <span class="kt">CGPoint</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">CGPoint</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">midX</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">midY</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">drawTrack</span><span class="p">(</span><span class="k">in</span> <span class="nv">ctx</span><span class="p">:</span> <span class="kt">CGContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="nf">setLineWidth</span><span class="p">(</span><span class="n">trackLineWidth</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="nf">setStrokeColor</span><span class="p">(</span><span class="n">trackColor</span><span class="o">.</span><span class="n">cgColor</span><span class="p">)</span>
        <span class="nf">drawSegmentes</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">ctx</span><span class="p">,</span> <span class="nv">progress</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">drawProgress</span><span class="p">(</span><span class="k">in</span> <span class="nv">ctx</span><span class="p">:</span> <span class="kt">CGContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="nf">setLineWidth</span><span class="p">(</span><span class="n">progressLineWidth</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="nf">setStrokeColor</span><span class="p">(</span><span class="n">progressColor</span><span class="o">.</span><span class="n">cgColor</span><span class="p">)</span>
        <span class="nf">drawSegmentes</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">ctx</span><span class="p">,</span> <span class="nv">progress</span><span class="p">:</span> <span class="n">progress</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">drawSegmentes</span><span class="p">(</span><span class="k">in</span> <span class="nv">ctx</span><span class="p">:</span> <span class="kt">CGContext</span><span class="p">,</span> <span class="nv">progress</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">segmentsCount</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">circle</span> <span class="o">=</span> <span class="kt">UIBezierPath</span><span class="p">(</span>
                <span class="nv">arcCenter</span><span class="p">:</span> <span class="n">center</span><span class="p">,</span>
                <span class="nv">radius</span><span class="p">:</span> <span class="n">radius</span><span class="p">,</span>
                <span class="nv">startAngle</span><span class="p">:</span> <span class="o">-</span><span class="kt">CGFloat</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                <span class="nv">endAngle</span><span class="p">:</span> <span class="p">(</span><span class="n">progress</span> <span class="o">*</span> <span class="kt">CGFloat</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="kt">CGFloat</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                <span class="nv">clockwise</span><span class="p">:</span> <span class="kc">true</span>
            <span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="nf">setLineCap</span><span class="p">(</span><span class="o">.</span><span class="n">round</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="nf">addPath</span><span class="p">(</span><span class="n">circle</span><span class="o">.</span><span class="n">cgPath</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="nf">strokePath</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="kt">Int</span><span class="p">(</span><span class="kt">CGFloat</span><span class="p">(</span><span class="n">segmentsCount</span><span class="p">)</span> <span class="o">*</span> <span class="n">progress</span><span class="p">)</span>
            <span class="k">var</span> <span class="nv">current</span> <span class="o">=</span> <span class="o">-</span><span class="kt">CGFloat</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="n">count</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">arc</span> <span class="o">=</span> <span class="kt">UIBezierPath</span><span class="p">(</span>
                    <span class="nv">arcCenter</span><span class="p">:</span> <span class="n">center</span><span class="p">,</span>
                    <span class="nv">radius</span><span class="p">:</span> <span class="n">radius</span><span class="p">,</span>
                    <span class="nv">startAngle</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span>
                    <span class="nv">endAngle</span><span class="p">:</span> <span class="n">current</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span>
                    <span class="nv">clockwise</span><span class="p">:</span> <span class="kc">true</span>
                <span class="p">)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="nf">setLineCap</span><span class="p">(</span><span class="o">.</span><span class="n">square</span><span class="p">)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="nf">addPath</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">cgPath</span><span class="p">)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="nf">strokePath</span><span class="p">()</span>
                <span class="n">current</span> <span class="o">+=</span> <span class="n">step</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Appearance of the progress like track and progress colors can be set during view initialization. Our <code class="language-plaintext highlighter-rouge">CircleProgressView</code> is just <code class="language-plaintext highlighter-rouge">ProgressView&lt;CircleProgressLayer&gt;</code>. All extra code is only to set up appearance properties.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="c1">/// Circle progress view width custom options</span>
<span class="kd">class</span> <span class="kt">CircleProgressView</span><span class="p">:</span> <span class="kt">ProgressView</span><span class="o">&lt;</span><span class="kt">CircleProgressLayer</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="kd">struct</span> <span class="kt">Options</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">segmentsCount</span><span class="p">:</span> <span class="kt">Int</span>
        <span class="k">let</span> <span class="nv">trackColor</span><span class="p">:</span> <span class="kt">UIColor</span>
        <span class="k">let</span> <span class="nv">trackLineWidth</span><span class="p">:</span> <span class="kt">CGFloat</span>
        <span class="k">let</span> <span class="nv">progressColor</span><span class="p">:</span> <span class="kt">UIColor</span>
        <span class="k">let</span> <span class="nv">progressLineWidth</span><span class="p">:</span> <span class="kt">CGFloat</span>

        <span class="nf">init</span><span class="p">(</span><span class="nv">segmentsCount</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
             <span class="nv">trackColor</span><span class="p">:</span> <span class="kt">UIColor</span> <span class="o">=</span> <span class="kt">UIColor</span><span class="p">(</span><span class="nv">red</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">green</span><span class="p">:</span> <span class="mi">148</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nv">blue</span><span class="p">:</span> <span class="mi">50</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nv">alpha</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">),</span>
             <span class="nv">trackLineWidth</span><span class="p">:</span> <span class="kt">CGFloat</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
             <span class="nv">progressColor</span><span class="p">:</span> <span class="kt">UIColor</span> <span class="o">=</span> <span class="kt">UIColor</span><span class="p">(</span><span class="nv">red</span><span class="p">:</span> <span class="mi">196</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nv">green</span><span class="p">:</span> <span class="mi">229</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nv">blue</span><span class="p">:</span> <span class="mi">56</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nv">alpha</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">),</span>
             <span class="nv">progressLineWidth</span><span class="p">:</span> <span class="kt">CGFloat</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">self</span><span class="o">.</span><span class="n">segmentsCount</span> <span class="o">=</span> <span class="n">segmentsCount</span>
            <span class="k">self</span><span class="o">.</span><span class="n">trackColor</span> <span class="o">=</span> <span class="n">trackColor</span>
            <span class="k">self</span><span class="o">.</span><span class="n">trackLineWidth</span> <span class="o">=</span> <span class="n">trackLineWidth</span>
            <span class="k">self</span><span class="o">.</span><span class="n">progressColor</span> <span class="o">=</span> <span class="n">progressColor</span>
            <span class="k">self</span><span class="o">.</span><span class="n">progressLineWidth</span> <span class="o">=</span> <span class="n">progressLineWidth</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">var</span> <span class="nv">options</span><span class="p">:</span> <span class="kt">Options</span> <span class="o">=</span> <span class="kt">Options</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="nf">applyOptions</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">convenience</span> <span class="nf">init</span><span class="p">(</span><span class="nv">options</span><span class="p">:</span> <span class="kt">Options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>

        <span class="k">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="nf">applyOptions</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">applyOptions</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">progressLayer</span><span class="o">.</span><span class="n">segmentsCount</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">segmentsCount</span>
        <span class="n">progressLayer</span><span class="o">.</span><span class="n">trackColor</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">trackColor</span>
        <span class="n">progressLayer</span><span class="o">.</span><span class="n">trackLineWidth</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">trackLineWidth</span>
        <span class="n">progressLayer</span><span class="o">.</span><span class="n">progressColor</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">progressColor</span>
        <span class="n">progressLayer</span><span class="o">.</span><span class="n">progressLineWidth</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">progressLineWidth</span>
        <span class="n">progressLayer</span><span class="o">.</span><span class="nf">setNeedsDisplay</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Full circle:</p><p><img data-src="/posts/calayer-animations/circle.png" alt="" data-proofer-ignore></p><p>Segmented one:</p><p><img data-src="/posts/calayer-animations/segmented-circle.png" alt="" data-proofer-ignore></p><p>The same with line progress view. Layer:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre><td class="rouge-code"><pre><span class="c1">/// Layer to style a line view progress</span>
<span class="kd">class</span> <span class="kt">LineProgressLayer</span><span class="p">:</span> <span class="kt">BaseProgressLayer</span> <span class="p">{</span>

    <span class="kd">@NSManaged</span> <span class="k">var</span> <span class="nv">segmentsCount</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="kd">@NSManaged</span> <span class="k">var</span> <span class="nv">lineWidth</span><span class="p">:</span> <span class="kt">CGFloat</span>
    <span class="kd">@NSManaged</span> <span class="k">var</span> <span class="nv">spacing</span><span class="p">:</span> <span class="kt">CGFloat</span>
    <span class="kd">@NSManaged</span> <span class="k">var</span> <span class="nv">trackColor</span><span class="p">:</span> <span class="kt">UIColor</span>
    <span class="kd">@NSManaged</span> <span class="k">var</span> <span class="nv">progressColor</span><span class="p">:</span> <span class="kt">UIColor</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">draw</span><span class="p">(</span><span class="k">in</span> <span class="nv">ctx</span><span class="p">:</span> <span class="kt">CGContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="nf">clear</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
        <span class="nf">drawTrack</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">ctx</span><span class="p">)</span>
        <span class="nf">drawProgress</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">segmentWidth</span><span class="p">:</span> <span class="kt">CGFloat</span> <span class="p">{</span>
        <span class="nf">return</span> <span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">segmentsCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">spacing</span><span class="p">)</span> <span class="o">/</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">segmentsCount</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">centerY</span><span class="p">:</span> <span class="kt">CGFloat</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">midY</span> <span class="o">-</span> <span class="n">lineWidth</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">drawTrack</span><span class="p">(</span><span class="k">in</span> <span class="nv">ctx</span><span class="p">:</span> <span class="kt">CGContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="nf">setFillColor</span><span class="p">(</span><span class="n">trackColor</span><span class="o">.</span><span class="n">cgColor</span><span class="p">)</span>
        <span class="nf">drawSegments</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">ctx</span><span class="p">,</span> <span class="nv">progress</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">drawProgress</span><span class="p">(</span><span class="k">in</span> <span class="nv">ctx</span><span class="p">:</span> <span class="kt">CGContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="nf">setFillColor</span><span class="p">(</span><span class="n">progressColor</span><span class="o">.</span><span class="n">cgColor</span><span class="p">)</span>
        <span class="nf">drawSegments</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">ctx</span><span class="p">,</span> <span class="nv">progress</span><span class="p">:</span> <span class="n">progress</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">drawSegments</span><span class="p">(</span><span class="k">in</span> <span class="nv">ctx</span><span class="p">:</span> <span class="kt">CGContext</span><span class="p">,</span> <span class="nv">progress</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">segmentsCount</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">rect</span> <span class="o">=</span> <span class="kt">UIBezierPath</span><span class="p">(</span><span class="nv">roundedRect</span><span class="p">:</span> <span class="kt">CGRect</span><span class="p">(</span>
                <span class="nv">x</span><span class="p">:</span> <span class="o">-</span><span class="n">lineWidth</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                <span class="nv">y</span><span class="p">:</span> <span class="n">centerY</span><span class="p">,</span>
                <span class="nv">width</span><span class="p">:</span> <span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">lineWidth</span><span class="p">)</span> <span class="o">*</span> <span class="n">progress</span><span class="p">,</span>
                <span class="nv">height</span><span class="p">:</span> <span class="n">lineWidth</span>
            <span class="p">),</span> <span class="nv">cornerRadius</span><span class="p">:</span> <span class="n">lineWidth</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="nf">addPath</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">cgPath</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="nf">fillPath</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="kt">Int</span><span class="p">(</span><span class="kt">CGFloat</span><span class="p">(</span><span class="n">segmentsCount</span><span class="p">)</span> <span class="o">*</span> <span class="n">progress</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="n">count</span> <span class="p">{</span>
                <span class="n">ctx</span><span class="o">.</span><span class="nf">fill</span><span class="p">(</span><span class="kt">CGRect</span><span class="p">(</span>
                    <span class="nv">x</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">segmentWidth</span> <span class="o">+</span> <span class="n">spacing</span><span class="p">),</span>
                    <span class="nv">y</span><span class="p">:</span> <span class="n">centerY</span><span class="p">,</span>
                    <span class="nv">width</span><span class="p">:</span> <span class="n">segmentWidth</span><span class="p">,</span>
                    <span class="nv">height</span><span class="p">:</span> <span class="n">lineWidth</span>
                <span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>View:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="c1">/// Line progress view with custom options</span>
<span class="kd">class</span> <span class="kt">LineProgressView</span><span class="p">:</span> <span class="kt">ProgressView</span><span class="o">&lt;</span><span class="kt">LineProgressLayer</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="kd">struct</span> <span class="kt">Options</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">segmentsCount</span><span class="p">:</span> <span class="kt">Int</span>
        <span class="k">let</span> <span class="nv">spacing</span><span class="p">:</span> <span class="kt">CGFloat</span>
        <span class="k">let</span> <span class="nv">lineWidth</span><span class="p">:</span> <span class="kt">CGFloat</span>
        <span class="k">let</span> <span class="nv">trackColor</span><span class="p">:</span> <span class="kt">UIColor</span>
        <span class="k">let</span> <span class="nv">progressColor</span><span class="p">:</span> <span class="kt">UIColor</span>

        <span class="nf">init</span><span class="p">(</span><span class="nv">segmentsCount</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
             <span class="nv">spacing</span><span class="p">:</span> <span class="kt">CGFloat</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
             <span class="nv">lineWidth</span><span class="p">:</span> <span class="kt">CGFloat</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
             <span class="nv">trackColor</span><span class="p">:</span> <span class="kt">UIColor</span> <span class="o">=</span> <span class="kt">UIColor</span><span class="p">(</span><span class="nv">red</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">green</span><span class="p">:</span> <span class="mi">98</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nv">blue</span><span class="p">:</span> <span class="mi">102</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nv">alpha</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">),</span>
             <span class="nv">progressColor</span><span class="p">:</span> <span class="kt">UIColor</span> <span class="o">=</span> <span class="kt">UIColor</span><span class="p">(</span><span class="nv">red</span><span class="p">:</span> <span class="mi">18</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nv">green</span><span class="p">:</span> <span class="mi">203</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nv">blue</span><span class="p">:</span> <span class="mi">196</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nv">alpha</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">))</span> <span class="p">{</span>

            <span class="k">self</span><span class="o">.</span><span class="n">segmentsCount</span> <span class="o">=</span> <span class="n">segmentsCount</span>
            <span class="k">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="n">spacing</span>
            <span class="k">self</span><span class="o">.</span><span class="n">lineWidth</span> <span class="o">=</span> <span class="n">lineWidth</span>
            <span class="k">self</span><span class="o">.</span><span class="n">trackColor</span> <span class="o">=</span> <span class="n">trackColor</span>
            <span class="k">self</span><span class="o">.</span><span class="n">progressColor</span> <span class="o">=</span> <span class="n">progressColor</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">var</span> <span class="nv">options</span><span class="p">:</span> <span class="kt">Options</span> <span class="o">=</span> <span class="kt">Options</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="nf">applyOptions</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">convenience</span> <span class="nf">init</span><span class="p">(</span><span class="nv">options</span><span class="p">:</span> <span class="kt">Options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>

        <span class="k">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="nf">applyOptions</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">applyOptions</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">progressLayer</span><span class="o">.</span><span class="n">segmentsCount</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">segmentsCount</span>
        <span class="n">progressLayer</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">spacing</span>
        <span class="n">progressLayer</span><span class="o">.</span><span class="n">lineWidth</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">lineWidth</span>
        <span class="n">progressLayer</span><span class="o">.</span><span class="n">trackColor</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">trackColor</span>
        <span class="n">progressLayer</span><span class="o">.</span><span class="n">progressColor</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">progressColor</span>
        <span class="n">progressLayer</span><span class="o">.</span><span class="nf">setNeedsDisplay</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Single line:</p><p><img data-src="/posts/calayer-animations/line.png" alt="" data-proofer-ignore></p><p>With segments:</p><p><img data-src="/posts/calayer-animations/segmented-line.png" alt="" data-proofer-ignore></p><p>Source and Xcode playground:</p><p><a href="https://github.com/avdyushin/ProgressView">https://github.com/avdyushin/ProgressView</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/swift/" class="post-tag no-text-decoration" >swift</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=CALayer+Animations+-+Grigory+Avdyushin&url=https%3A%2F%2Fblog.grigory.nl%2Fposts%2Fcalayer-animations%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=CALayer+Animations+-+Grigory+Avdyushin&u=https%3A%2F%2Fblog.grigory.nl%2Fposts%2Fcalayer-animations%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.grigory.nl%2Fposts%2Fcalayer-animations%2F&text=CALayer+Animations+-+Grigory+Avdyushin" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/swift-property-wrappers/">Building Swift DI using Property Wrappers</a><li><a href="/posts/building-splitview-in-swiftui/">Building Split View in SwiftUI</a><li><a href="/posts/xslt-auto-generation/">Using XML and XSLT for code generation</a><li><a href="/posts/cycling-power/">Cycling power calculation</a><li><a href="/posts/swift-keypaths/">Swift keypaths</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/macos/">macos</a> <a class="post-tag" href="/tags/swift/">swift</a> <a class="post-tag" href="/tags/retro/">retro</a> <a class="post-tag" href="/tags/raspberry-pi/">raspberry pi</a> <a class="post-tag" href="/tags/swiftui/">swiftui</a> <a class="post-tag" href="/tags/vim/">vim</a> <a class="post-tag" href="/tags/grep/">grep</a> <a class="post-tag" href="/tags/keyboards/">keyboards</a> <a class="post-tag" href="/tags/xml/">xml</a> <a class="post-tag" href="/tags/xslt/">xslt</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/swift-property-wrappers/"><div class="card-body"> <em class="small" data-ts="1589468025" data-df="ll" > May 14, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Building Swift DI using Property Wrappers</h3><div class="text-muted small"><p> Dependency Injection using Swift Property Wrappers Note: Code tested using Swift 5.2.2 and Xcode 11.4.1 Dependency Injection Dependency Injection (DI) helps us to separate creation and usage of ...</p></div></div></a></div><div class="card"> <a href="/posts/building-splitview-in-swiftui/"><div class="card-body"> <em class="small" data-ts="1590231653" data-df="ll" > May 23, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Building Split View in SwiftUI</h3><div class="text-muted small"><p> Introduction SwiftUI in Playground Xcode’s Playground templates unfortunately has none of them for SwiftUI. For now we can create a new Blank Playground project and add boilerplate code: 1 2 3 4...</p></div></div></a></div><div class="card"> <a href="/posts/swift-keypaths/"><div class="card-body"> <em class="small" data-ts="1592903441" data-df="ll" > Jun 23, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Swift keypaths</h3><div class="text-muted small"><p> Extending Sequence to have method that calculates sum: 1 2 3 extension Sequence where Element: AdditiveArithmetic { func sum() -&amp;gt; Element { reduce(.zero, +) } } This sum() available for a...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/using-mixins-in-swift/" class="btn btn-outline-primary" prompt="Older"><p>Using Mixins in Swift</p></a> <a href="/posts/vim-clipboard/" class="btn btn-outline-primary" prompt="Newer"><p>Using system clipboard in Vim on macOS</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/avdyushin">Grigory Avdyushin</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/macos/">macos</a> <a class="post-tag" href="/tags/swift/">swift</a> <a class="post-tag" href="/tags/retro/">retro</a> <a class="post-tag" href="/tags/raspberry-pi/">raspberry pi</a> <a class="post-tag" href="/tags/swiftui/">swiftui</a> <a class="post-tag" href="/tags/vim/">vim</a> <a class="post-tag" href="/tags/grep/">grep</a> <a class="post-tag" href="/tags/keyboards/">keyboards</a> <a class="post-tag" href="/tags/xml/">xml</a> <a class="post-tag" href="/tags/xslt/">xslt</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
